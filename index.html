<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warehouse Shield - Central SO</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/1067/1067256.png">
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        input, button { transition: none !important; }
        .stat-card { border: 1px solid #f1f5f9; background: white; border-radius: 1.25rem; transition: all 0.2s ease; }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 15px 30px -10px rgba(0,0,0,0.05); }
        .modal-enter { animation: modalIn 0.2s ease-out forwards; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-[#F8FAFC]">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- MASUKKAN URL GOOGLE APPS SCRIPT ANDA ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyskukdWfFE_lG9pTQGpl7LrtLwZniUXesFFQZlrckvXIC41PP7vJredNDH5S6sbaC8/exec"; 

        const Icon = ({ name, className = "w-5 h-5" }) => {
            const icons = {
                shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />,
                camera: <React.Fragment><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" /><circle cx="12" cy="13" r="4" /></React.Fragment>,
                refresh: <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />,
                logout: <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9" />,
                trash: <React.Fragment><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></React.Fragment>,
                dashboard: <React.Fragment><rect x="3" y="3" width="7" height="7" /><rect x="14" y="3" width="7" height="7" /><rect x="14" y="14" width="7" height="7" /><rect x="3" y="14" width="7" height="7" /></React.Fragment>,
                trendingUp: <polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />,
                trendingDown: <polyline points="23 18 13.5 8.5 8.5 13.5 1 6" />,
                chevronDown: <polyline points="6 9 12 15 18 9" />,
                chevronUp: <polyline points="18 15 12 9 6 15" />,
                calendar: <React.Fragment><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></React.Fragment>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || null}
                </svg>
            );
        };

        function App() {
            const [view, setView] = useState('login');
            const [currentUser, setCurrentUser] = useState(null);
            const [currentEntity, setCurrentEntity] = useState('ZAN');
            const [loading, setLoading] = useState(false);
            const [filter, setFilter] = useState('1M');
            const [customDates, setCustomDates] = useState({ start: '', end: '' });
            
            const [masterData, setMasterData] = useState({ 
                soZan: [], soDnk: [], itemMaster: [], users: [], 
                trends: { 
                    zan: { plus:[], minus:[], totalSku:0, totalPlusCount:0, totalMinusCount:0, totalMatch:0, history:[] }, 
                    dnk: { plus:[], minus:[], totalSku:0, totalPlusCount:0, totalMinusCount:0, totalMatch:0, history:[] } 
                }
            });
            const [formData, setFormData] = useState({ item_code: '', item_name: '', system_stock: '', actual_stock: '' });
            const [additionalNote, setAdditionalNote] = useState('');
            const [modal, setModal] = useState({ show: false, type: '', nextEntity: null });
            const [scannerActive, setScannerActive] = useState(false);
            const [toast, setToast] = useState({ show: false, message: '' });

            const scannerObj = useRef(null);

            useEffect(() => {
                const saved = localStorage.getItem('ws_session');
                if (saved) { setCurrentUser(JSON.parse(saved)); setView('so'); }
                fetchData(false, false);
            }, []);

            useEffect(() => {
                if (view === 'dashboard') fetchData(true, true);
                else fetchData(true, false);
            }, [filter, view, customDates.start, customDates.end]);

            const fetchData = async (isLite = true, includeDashboard = false) => {
                if (!SCRIPT_URL.includes("https")) return;
                setLoading(true);
                try {
                    let url = `${SCRIPT_URL}?range=${filter}&lite=${isLite}&dashboard=${includeDashboard}`;
                    if (customDates.start && customDates.end) {
                        url += `&startDate=${customDates.start}&endDate=${customDates.end}`;
                    }
                    const res = await fetch(url);
                    const data = await res.json();
                    setMasterData(prev => ({
                        ...data,
                        itemMaster: isLite ? prev.itemMaster : data.itemMaster,
                        users: isLite ? prev.users : data.users,
                        trends: includeDashboard ? data.trends : prev.trends
                    }));
                } catch (err) { console.error(err); }
                finally { setLoading(false); }
            };

            const handleLogin = (e) => {
                e.preventDefault();
                const user = masterData.users.find(u => u.Username === e.target.username.value && u.Key === e.target.password.value);
                if (user) { setCurrentUser(user); localStorage.setItem('ws_session', JSON.stringify(user)); setView('so'); }
                else alert("Username/Key Salah!");
            };

            const handleItemCodeChange = (val) => {
                setFormData(p => ({ ...p, item_code: val }));
                const searchCode = val.trim().toUpperCase();
                const item = masterData.itemMaster.find(i => i.KODEBAHANBAKU === searchCode);
                setFormData(p => ({ ...p, item_name: item ? item.NAMABAHANBAKU : "..." }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                const code = formData.item_code.trim().toUpperCase();
                const currentTable = currentEntity === 'ZAN' ? masterData.soZan : masterData.soDnk;
                const exists = currentTable.some(r => r.KodeBahan.trim().toUpperCase() === code);
                if (exists) setModal({ show: true, type: 'duplicate' });
                else submitToCloud();
            };

            const submitToCloud = async (isUpdate = false) => {
                setModal({ show: false }); 
                setLoading(true);
                const code = formData.item_code.trim().toUpperCase();
                const sys = Number(formData.system_stock);
                const act = Number(formData.actual_stock);
                const diff = act - sys;

                const body = new URLSearchParams();
                body.append("item_code", code);
                body.append("system_stock", sys);
                body.append("actual_stock", act);
                body.append("item_name", formData.item_name);
                body.append("entity", currentEntity);
                body.append("staff_name", currentUser.Nama);
                body.append("input_time", new Date().toLocaleTimeString('id-ID'));
                if (isUpdate) body.append("action", "update");

                try {
                    const res = await fetch(SCRIPT_URL, { method: 'POST', body: body, headers: { 'Content-Type': 'application/x-www-form-urlencoded' } });
                    const json = await res.json();
                    if (json.status === 'success') {
                        const newEntry = { Tanggal: new Date().toLocaleDateString('id-ID'), KodeBahan: code, StokSistem: sys, StokAktual: act, Selisih: diff, NamaBahan: formData.item_name };
                        setMasterData(prev => {
                            const tableKey = currentEntity === 'ZAN' ? 'soZan' : 'soDnk';
                            let newTable = [...prev[tableKey]];
                            const existingIndex = newTable.findIndex(r => r.KodeBahan === code);
                            if (existingIndex > -1) newTable[existingIndex] = newEntry;
                            else newTable.unshift(newEntry);
                            return { ...prev, [tableKey]: newTable };
                        });
                        setFormData({ item_code: '', item_name: '', system_stock: '', actual_stock: '' });
                        setToast({ show: true, message: isUpdate ? "DATA DIUPDATE" : "DATA TERSIMPAN" });
                        setTimeout(() => setToast({ show: false }), 3000);
                        document.getElementById('item_input_focus')?.focus();
                    }
                } catch (err) { alert("Error Simpan: Silakan coba lagi"); }
                finally { setLoading(false); }
            };

            const handleCancelDuplicate = () => {
                setFormData({ item_code: '', item_name: '', system_stock: '', actual_stock: '' });
                setModal({ show: false });
                setTimeout(() => document.getElementById('item_input_focus')?.focus(), 100);
            };

            const attemptSwitch = (entity) => {
                if (entity === currentEntity) return;
                if (additionalNote.trim()) setModal({ show: true, type: 'switch', nextEntity: entity });
                else setCurrentEntity(entity);
            };

            const confirmSwitch = (confirm) => {
                if (confirm) { setAdditionalNote(''); setCurrentEntity(modal.nextEntity); }
                setModal({ show: false, type: '', nextEntity: null });
            };

            const toggleScanner = async () => {
                if (scannerActive) {
                    if (scannerObj.current) {
                        try {
                            await scannerObj.current.stop();
                        } catch (err) {
                            console.error("Gagal menghentikan kamera:", err);
                        }
                        scannerObj.current = null;
                    }
                    setScannerActive(false);
                } else {
                    setScannerActive(true);
                    // Gunakan setTimeout untuk memastikan elemen #reader sudah ada di DOM
                    setTimeout(() => {
                        const html5QrCode = new Html5Qrcode("reader");
                        scannerObj.current = html5QrCode;
                        html5QrCode.start(
                            { facingMode: "environment" },
                            { fps: 25, qrbox: 250 },
                            async (text) => {
                                handleItemCodeChange(text);
                                try {
                                    await html5QrCode.stop();
                                } catch (err) {
                                    console.error("Gagal stop kamera setelah scan:", err);
                                }
                                scannerObj.current = null;
                                setScannerActive(false);
                            }
                        ).catch((err) => {
                            console.error("Error start scanner:", err);
                            alert("Kamera Gagal Dimulai. Pastikan izin kamera diberikan.");
                            setScannerActive(false);
                        });
                    }, 300);
                }
            };

            const exportPDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const data = currentEntity === 'ZAN' ? masterData.soZan : masterData.soDnk;
                const today = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                doc.setFontSize(14).setFont(undefined, 'bold').text("LAPORAN STOCK OPNAME GUDANG CENTRAL", 105, 15, { align: "center" });
                doc.setFontSize(16).setTextColor(currentEntity === 'ZAN' ? '#2563eb' : '#059669').text(currentEntity, 105, 23, { align: "center" });
                doc.setFontSize(8).setTextColor('#94a3b8').setFont(undefined, 'normal');
                doc.text(`Tanggal SO: ${today}`, 105, 28, { align: "center" });
                doc.text(`Waktu Cetak: ${new Date().toLocaleString('id-ID')} WIB`, 105, 32, { align: "center" });
                doc.text(`Dicetak Oleh: ${currentUser.Nama}, ${currentUser.Jabatan}`, 105, 36, { align: "center" });
                const rows = data.map(r => {
                    const item = masterData.itemMaster.find(i => i.KODEBAHANBAKU === r.KodeBahan);
                    return [r.KodeBahan, item ? item.NAMABAHANBAKU : "-", r.StokSistem, r.StokAktual, r.Selisih, "", ""];
                });
                doc.autoTable({
                    startY: 42,
                    head: [['Kode', 'Nama Bahan', 'Sistem', 'Aktual', 'Selisih', 'Keterangan', 'Rekonsiliasi']],
                    body: rows, theme: 'grid',
                    headStyles: { fillColor: currentEntity === 'ZAN' ? [37, 99, 235] : [15, 23, 42], fontSize: 7, halign: 'center' },
                    styles: { fontSize: 7 },
                    columnStyles: { 0: { cellWidth: 22 }, 1: { cellWidth: 42 }, 2: { cellWidth: 15 }, 3: { cellWidth: 15 }, 4: { cellWidth: 15 }, 5: { cellWidth: 50 }, 6: { cellWidth: 23 } }
                });
                let fY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(9).setTextColor(0).setFont(undefined, 'bold').text("Catatan Tambahan:", 14, fY);
                doc.rect(14, fY + 2, 182, 15);
                if(additionalNote) doc.setFont(undefined, 'normal').text(doc.splitTextToSize(additionalNote, 178), 16, fY + 7);
                fY += 35;
                doc.text("Koordinator Gudang,", 40, fY, { align: "center" });
                doc.text("Admin Gudang,", 170, fY, { align: "center" });
                doc.text("Mengetahui,", 105, fY + 15, { align: "center" });
                doc.text("Supervisor Gudang,", 105, fY + 20, { align: "center" });
                doc.line(20, fY + 18, 60, fY + 18); doc.line(150, fY + 18, 190, fY + 18); doc.line(85, fY + 38, 125, fY + 38); 
                doc.save(`Laporan_SO_${currentEntity}.pdf`);
            };

            const DashboardUnit = ({ unit, data }) => {
                const pieRef = useRef(null);
                const trendRef = useRef(null);
                const charts = useRef({ pie: null, trend: null });
                const [showDetails, setShowDetails] = useState(false);

                useEffect(() => {
                    if (pieRef.current && trendRef.current && data) {
                        if (charts.current.pie) charts.current.pie.destroy();
                        if (charts.current.trend) charts.current.trend.destroy();
                        charts.current.pie = new Chart(pieRef.current, {
                            type: 'doughnut',
                            data: {
                                labels: ['Sesuai', 'Surplus', 'Minus'],
                                datasets: [{ data: [data.totalMatch || 0, data.totalPlusCount || 0, data.totalMinusCount || 0], backgroundColor: ['#10b981', '#f59e0b', '#ef4444'], borderWidth: 0 }]
                            },
                            options: { cutout: '80%', plugins: { legend: { display: false } } }
                        });
                        charts.current.trend = new Chart(trendRef.current, {
                            type: 'line',
                            data: {
                                labels: data.history ? data.history.map(h => h.label) : [],
                                datasets: [
                                    { label: 'Surplus', data: data.history ? data.history.map(h => h.plus) : [], borderColor: '#f59e0b', backgroundColor: '#f59e0b20', fill: true, tension: 0.4, pointRadius: 2 },
                                    { label: 'Minus', data: data.history ? data.history.map(h => h.minus) : [], borderColor: '#ef4444', backgroundColor: '#ef444420', fill: true, tension: 0.4, pointRadius: 2 }
                                ]
                            },
                            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { font: { size: 9 } } }, y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
                        });
                    }
                }, [data]);

                const accuracy = (data.totalMatch + data.totalPlusCount + data.totalMinusCount) > 0 ? Math.round((data.totalMatch / (data.totalMatch + data.totalPlusCount + data.totalMinusCount)) * 100) : 0;

                return (
                    <div className="space-y-6 text-slate-800">
                        <div className="flex items-center gap-3"><div className={`w-1.5 h-6 rounded-full ${unit === 'zan' ? 'bg-blue-600' : 'bg-emerald-600'}`}></div><h2 className="text-xl font-black uppercase tracking-tight">Unit Usaha: {unit.toUpperCase()}</h2></div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div className="stat-card p-6 border-l-4 border-l-slate-800"><span className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">SKU Diperiksa</span><span className="text-3xl font-black">{data.totalSku || 0}</span></div>
                            <div className="stat-card p-6 border-l-4 border-l-amber-500"><span className="text-[10px] font-black text-amber-500 uppercase tracking-widest block mb-1">Total Surplus</span><span className="text-3xl font-black">+{data.totalPlusCount || 0}</span></div>
                            <div className="stat-card p-6 border-l-4 border-l-red-500"><span className="text-[10px] font-black text-red-500 uppercase tracking-widest block mb-1">Total Minus</span><span className="text-3xl font-black">-{data.totalMinusCount || 0}</span></div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="stat-card p-8 flex items-center justify-between">
                                <div className="w-32 h-32 relative"><canvas ref={pieRef}></canvas><div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none"><span className="text-[8px] font-black text-slate-400 uppercase leading-none">Akurasi</span><span className="text-xl font-black">{accuracy}%</span></div></div>
                                <div className="space-y-4 flex-1 ml-10">
                                    <div className="flex justify-between items-center text-xs font-bold text-slate-400"><span>SESUAI</span><span className="text-emerald-600">{data.totalMatch || 0}</span></div>
                                    <div className="flex justify-between items-center text-xs font-bold text-slate-400"><span>SURPLUS</span><span className="text-amber-600">+{data.totalPlusCount || 0}</span></div>
                                    <div className="flex justify-between items-center text-xs font-bold text-slate-400"><span>MINUS</span><span className="text-red-600">-{data.totalMinusCount || 0}</span></div>
                                </div>
                            </div>
                            <div className="stat-card p-8 flex flex-col">
                                <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Trend Perbandingan Selisih</h3>
                                <div className="flex-1 h-32"><canvas ref={trendRef}></canvas></div>
                            </div>
                        </div>

                        {/* Collapsible Top 5 */}
                        <div className="space-y-4">
                            <button onClick={() => setShowDetails(!showDetails)} className="w-full py-4 bg-white border border-slate-200 rounded-2xl font-black uppercase text-[10px] tracking-widest text-slate-400 hover:text-slate-800 flex items-center justify-center gap-2 transition-all shadow-sm">
                                <Icon name={showDetails ? "chevronUp" : "chevronDown"} className="w-3 h-3" />
                                {showDetails ? "Sembunyikan" : "Lihat Detail Produk Selisih"}
                            </button>

                            {showDetails && (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 animate-in fade-in slide-in-from-top-2 duration-300">
                                    <div className="stat-card p-6 border-amber-100 bg-amber-50/20">
                                        <h3 className="text-[10px] font-black text-amber-500 uppercase tracking-widest mb-4 flex items-center gap-2"><Icon name="trendingUp" className="w-3 h-3" /> Top 5 Surplus</h3>
                                        <div className="space-y-2">
                                            {data.plus && data.plus.map((t, i) => (
                                                <div key={i} className="flex justify-between items-center text-[10px] font-bold bg-white p-2.5 rounded-xl border border-amber-50 shadow-sm">
                                                    <span className="truncate w-4/5 uppercase text-slate-700">{t.code} - {masterData.itemMaster.find(m => m.KODEBAHANBAKU === t.code)?.NAMABAHANBAKU || 'Item'}</span>
                                                    <span className="text-amber-600">{t.count}x</span>
                                                </div>
                                            ))}
                                            {(!data.plus || data.plus.length === 0) && <p className="text-slate-300 italic text-[10px]">Data bersih</p>}
                                        </div>
                                    </div>
                                    <div className="stat-card p-6 border-red-100 bg-red-50/20">
                                        <h3 className="text-[10px] font-black text-red-500 uppercase tracking-widest mb-4 flex items-center gap-2"><Icon name="trendingDown" className="w-3 h-3" /> Top 5 Minus</h3>
                                        <div className="space-y-2">
                                            {data.minus && data.minus.map((t, i) => (
                                                <div key={i} className="flex justify-between items-center text-[10px] font-bold bg-white p-2.5 rounded-xl border border-red-50 shadow-sm">
                                                    <span className="truncate w-4/5 uppercase text-slate-700">{t.code} - {masterData.itemMaster.find(m => m.KODEBAHANBAKU === t.code)?.NAMABAHANBAKU || 'Item'}</span>
                                                    <span className="text-red-600">{t.count}x</span>
                                                </div>
                                            ))}
                                            {(!data.minus || data.minus.length === 0) && <p className="text-slate-300 italic text-[10px]">Data bersih</p>}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            if (view === 'login') return (
                <div className="min-h-screen bg-slate-900 flex items-center justify-center p-6 text-slate-800">
                    <div className="bg-white rounded-[2.5rem] w-full max-w-sm p-10 shadow-2xl">
                        <div className="flex justify-center mb-6"><div className="bg-slate-800 p-5 rounded-3xl"><Icon name="shield" className="w-10 h-10 text-yellow-400" /></div></div>
                        <h1 className="text-2xl font-black text-center tracking-tight mb-8 uppercase">Central Shield</h1>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input name="username" placeholder="Username" required className="w-full bg-slate-50 rounded-2xl py-4 px-6 font-bold outline-none focus:ring-2 focus:ring-slate-800" />
                            <input name="password" type="password" placeholder="Key" required className="w-full bg-slate-50 rounded-2xl py-4 px-6 font-bold outline-none focus:ring-2 focus:ring-slate-800 tracking-widest" />
                            <button type="submit" className="w-full bg-slate-800 text-white font-black py-4 rounded-2xl shadow-xl uppercase text-sm tracking-widest hover:bg-black transition-colors">Unlock</button>
                        </form>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen pb-12 text-slate-800">
                    {modal.show && (
                        <div className="fixed inset-0 z-[500] flex items-center justify-center p-6 bg-slate-900/60 backdrop-blur-sm">
                            <div className="bg-white rounded-[2rem] p-8 w-full max-w-sm shadow-2xl modal-enter">
                                <h3 className="text-xl font-black mb-2 uppercase tracking-tight">{modal.type === 'duplicate' ? 'Sudah Diinput' : 'Konfirmasi Pindah'}</h3>
                                <p className="text-slate-500 text-sm mb-8 font-medium">{modal.type === 'duplicate' ? 'Update data hari ini?' : 'Pindah Unit Usaha? Catatan akan bersih.'}</p>
                                <div className="flex gap-3">
                                    <button onClick={() => modal.type === 'duplicate' ? handleCancelDuplicate() : confirmSwitch(false)} className="flex-1 py-4 bg-slate-100 rounded-2xl font-bold uppercase text-xs">Tidak</button>
                                    <button onClick={() => modal.type === 'duplicate' ? submitToCloud(true) : confirmSwitch(true)} className={`flex-1 py-4 text-white rounded-2xl font-black uppercase text-xs shadow-lg ${modal.type === 'duplicate' ? 'bg-blue-600' : 'bg-red-500'}`}>Ya</button>
                                </div>
                            </div>
                        </div>
                    )}
                    <div className="max-w-4xl mx-auto p-4 md:p-8">
                        <div className="flex items-center justify-between mb-8">
                            <div className="flex gap-2">
                                <button onClick={() => setView('so')} className={`p-4 rounded-2xl font-black text-[10px] uppercase tracking-widest border-2 transition-all ${view === 'so' ? 'bg-white border-slate-800 shadow-sm text-slate-800' : 'text-slate-400 border-transparent hover:bg-white/50'}`}>SO INPUT</button>
                                {(currentUser?.Jabatan?.includes("Supervisor") || currentUser?.Jabatan?.includes("Manager")) && (
                                    <button onClick={() => setView('dashboard')} className={`p-4 rounded-2xl font-black text-[10px] uppercase tracking-widest border-2 transition-all ${view === 'dashboard' ? 'bg-white border-slate-800 shadow-sm text-slate-800' : 'text-slate-400 border-transparent hover:bg-white/50'}`}>DASHBOARD</button>
                                )}
                            </div>
                            <button onClick={() => { localStorage.removeItem('ws_session'); window.location.reload(); }} className="p-3 bg-white rounded-2xl border border-slate-100 text-slate-300 hover:text-red-500 shadow-sm"><Icon name="logout" className="w-5 h-5" /></button>
                        </div>

                        {view === 'so' ? (
                            <>
                                <div className="flex gap-4 mb-8">
                                    <button onClick={() => attemptSwitch('ZAN')} className={`flex-1 py-4 rounded-2xl font-black text-xs border-2 transition-all ${currentEntity === 'ZAN' ? 'bg-blue-50 border-blue-600 text-blue-600 shadow-sm' : 'bg-white border-transparent text-slate-300 hover:bg-white/30'}`}>ZAN</button>
                                    <button onClick={() => attemptSwitch('DNK')} className={`flex-1 py-4 rounded-2xl font-black text-xs border-2 transition-all ${currentEntity === 'DNK' ? 'bg-emerald-50 border-emerald-600 text-emerald-600 shadow-sm' : 'bg-white border-transparent text-slate-300 hover:bg-white/30'}`}>DNK</button>
                                </div>
                                <header className={`bg-white rounded-[2rem] p-8 border-b-4 mb-8 flex flex-col md:flex-row md:items-center justify-between gap-6 shadow-sm ${currentEntity === 'ZAN' ? 'border-blue-600' : 'border-emerald-600'}`}>
                                    <div className="flex items-center gap-4"><div className={`p-4 rounded-2xl text-white ${currentEntity === 'ZAN' ? 'bg-blue-600' : 'bg-slate-900'}`}><Icon name="shield" className="w-6 h-6" /></div><div><h1 className="text-2xl font-black tracking-tight uppercase tracking-tighter">Warehouse Shield: {currentEntity}</h1><p className="text-blue-600 text-[10px] font-black uppercase tracking-[0.2em]">Quick Daily Stock Opname</p><p className="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Petugas: <span className="text-slate-900 font-black uppercase">{currentUser?.Nama}</span></p></div></div>
                                    <div className="bg-slate-50 border border-slate-100 px-6 py-3 rounded-2xl font-bold text-slate-700 text-sm uppercase font-black">{new Date().toLocaleDateString('id-ID', {day:'numeric', month:'long', year:'numeric'})}</div>
                                </header>
                                
                                {scannerActive && (
                                    <div className="bg-slate-900 rounded-[2rem] overflow-hidden mb-8 border-4 border-yellow-400 shadow-2xl relative">
                                        <div id="reader" className="w-full"></div>
                                        <button onClick={toggleScanner} className="w-full bg-yellow-400 py-4 font-black uppercase text-xs tracking-widest">Close Camera</button>
                                    </div>
                                )}

                                <div className="bg-white rounded-[2.5rem] p-10 shadow-xl shadow-slate-200/50 border border-slate-100 relative mb-12">
                                    {loading && <div className="absolute inset-0 bg-white/80 backdrop-blur-sm z-[200] flex items-center justify-center rounded-[2.5rem]"><Icon name="refresh" className="animate-spin w-10 h-10 text-slate-800" /></div>}
                                    <form onSubmit={handleSubmit} className="space-y-6">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                            <div className="space-y-2">
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Kode Bahan</label>
                                                <div className="flex gap-2">
                                                    <input id="item_input_focus" value={formData.item_code} onChange={e => handleItemCodeChange(e.target.value)} required placeholder="SCAN/KETIK..." className="w-full bg-slate-50 rounded-2xl py-4 px-6 font-bold uppercase outline-none focus:ring-2 focus:ring-yellow-400" autoComplete="off" autoCorrect="off" spellCheck="false" autoCapitalize="characters" />
                                                    <button type="button" onClick={toggleScanner} className={`p-4 rounded-2xl text-white shadow-lg ${currentEntity === 'ZAN' ? 'bg-blue-600' : 'bg-amber-400'} hover:scale-105 transition-transform`}><Icon name="camera" className="w-6 h-6" /></button>
                                                </div>
                                            </div>
                                            <div className="space-y-2"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Nama Referensi</label><input value={formData.item_name} readOnly className="w-full bg-slate-50 text-slate-400 rounded-2xl py-4 px-6 font-bold uppercase outline-none italic font-bold" /></div>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                            <div className="space-y-2"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Stok Sistem</label><input type="number" value={formData.system_stock} onChange={e => setFormData({...formData, system_stock:e.target.value})} required placeholder="0" className="w-full bg-slate-50 rounded-2xl py-4 px-6 font-bold outline-none focus:ring-2 focus:ring-yellow-400" /></div>
                                            <div className="space-y-2"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Stok Aktual</label><input type="number" value={formData.actual_stock} onChange={e => setFormData({...formData, actual_stock:e.target.value})} required placeholder="0" className="w-full bg-slate-50 rounded-2xl py-4 px-6 font-bold outline-none focus:ring-2 focus:ring-yellow-400" /></div>
                                        </div>
                                        <button type="submit" className={`w-full py-5 rounded-2xl font-black uppercase tracking-widest text-white shadow-xl active:scale-[0.98] ${currentEntity === 'ZAN' ? 'bg-blue-600 hover:bg-blue-700' : 'bg-slate-900 hover:bg-black'}`}>Submit Data SO</button>
                                    </form>
                                </div>
                                <div className="mb-12">
                                    <div className="flex items-center justify-between mb-6 px-4"><h2 className="text-lg font-black uppercase tracking-tight font-black">Monitoring Hari Ini</h2><div className="flex gap-4">
                                            <button onClick={() => fetchData(true, false)} className="p-2 text-slate-300 hover:text-slate-800 transition-colors"><Icon name="refresh" className={`w-5 h-5 ${loading && 'animate-spin'}`} /></button>
                                            <button onClick={exportPDF} className={`px-6 py-2 rounded-xl text-xs font-black uppercase text-white shadow-lg transition-all hover:scale-105 ${currentEntity === 'ZAN' ? 'bg-blue-600 shadow-blue-100' : 'bg-emerald-600 shadow-emerald-100'}`}>Export PDF</button></div></div>
                                    <div className="bg-white rounded-[2rem] overflow-hidden border border-slate-100 shadow-sm"><div className="overflow-x-auto"><table className="w-full text-left text-slate-800"><thead className="bg-slate-50 border-b border-slate-100 text-slate-400 text-[9px] font-black uppercase tracking-widest"><tr><th className="px-8 py-5">Item Code</th><th className="px-6 py-5 text-center">System</th><th className="px-6 py-5 text-center">Actual</th><th className="px-6 py-5 text-center">Variance</th></tr></thead>
                                                <tbody className="divide-y divide-slate-50 font-bold text-sm">
                                                    {(masterData[`so${currentEntity.charAt(0).toUpperCase() + currentEntity.slice(1).toLowerCase()}`]?.length === 0) ? (<tr><td colSpan="4" className="px-8 py-16 text-center text-slate-300 italic font-medium uppercase text-[10px]">Belum ada data SO</td></tr>) : 
                                                    (masterData[`so${currentEntity.charAt(0).toUpperCase() + currentEntity.slice(1).toLowerCase()}`].map((row, i) => (
                                                        <tr key={i} className="hover:bg-slate-50 transition-colors uppercase"><td className="px-8 py-5 uppercase tracking-tight">{row.KodeBahan}</td><td className="px-6 py-5 text-center font-medium">{row.StokSistem}</td><td className="px-6 py-5 text-center font-medium">{row.StokAktual}</td><td className={`px-6 py-5 text-center font-black ${Number(row.Selisih) === 0 ? 'text-green-500' : 'text-red-500'}`}>{Number(row.Selisih) > 0 ? '+'+row.Selisih : row.Selisih}</td></tr>
                                                    )))}
                                                </tbody></table></div></div></div>
                                <div className="bg-white rounded-[2rem] p-8 border border-slate-100 shadow-sm"><div className="flex items-center justify-between mb-4"><h3 className="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center gap-2">Catatan Rekonsiliasi (PDF)</h3><button onClick={() => setAdditionalNote('')} className="text-[10px] font-black uppercase text-red-500 flex items-center gap-1 hover:text-red-700 font-black uppercase"><Icon name="trash" className="w-3 h-3" /> Bersihkan</button></div>
                                    <textarea value={additionalNote} onChange={e => setAdditionalNote(e.target.value)} rows="3" placeholder="Ketik catatan..." className="w-full bg-slate-50 rounded-2xl py-4 px-6 outline-none text-sm font-medium resize-none focus:bg-white focus:ring-1 focus:ring-slate-200 transition-all font-bold" /></div>
                            </>
                        ) : (
                            <div className="space-y-8 animate-in slide-in-from-bottom-4 duration-500">
                                <header className="bg-slate-900 rounded-[2.5rem] p-10 text-white shadow-2xl relative overflow-hidden flex flex-col md:flex-row md:items-end justify-between gap-6">
                                    <Icon name="shield" className="absolute -right-10 -bottom-10 w-64 h-64 text-white/5 rotate-12" />
                                    <div className="relative z-10">
                                        <h1 className="text-3xl font-black mb-1 tracking-tight uppercase">Dashboard Analytics</h1>
                                        <p className="text-yellow-400 font-bold uppercase text-[9px] tracking-[0.4em]">Warehouse Performance Insights</p>
                                    </div>
                                    <div className="flex flex-col gap-4 relative z-10">
                                        {/* Custom Date Range Filter UI */}
                                        <div className="flex items-center gap-3 bg-white/10 p-2 rounded-2xl border border-white/10">
                                            <div className="flex items-center gap-2 px-2 border-r border-white/10">
                                                <Icon name="calendar" className="w-3 h-3 text-white/50" />
                                                <input type="date" value={customDates.start} onChange={e => setCustomDates({...customDates, start: e.target.value})} className="bg-transparent text-[10px] text-white outline-none [color-scheme:dark]" />
                                            </div>
                                            <div className="flex items-center gap-2 px-2">
                                                <input type="date" value={customDates.end} onChange={e => setCustomDates({...customDates, end: e.target.value})} className="bg-transparent text-[10px] text-white outline-none [color-scheme:dark]" />
                                            </div>
                                            {(customDates.start || customDates.end) && (
                                                <button onClick={() => setCustomDates({start:'', end:''})} className="p-1 hover:bg-red-500 rounded-lg transition-colors"><Icon name="trash" className="w-3 h-3" /></button>
                                            )}
                                        </div>
                                        <div className="flex bg-white/10 p-1 rounded-2xl self-end">
                                            <button onClick={() => setFilter('1M')} className={`px-5 py-2 rounded-xl text-[10px] font-black uppercase transition-all ${filter === '1M' && !customDates.start ? 'bg-white text-slate-900 shadow-lg' : 'text-white/60 hover:text-white'}`}>1 Bulan</button>
                                            <button onClick={() => setFilter('3M')} className={`px-5 py-2 rounded-xl text-[10px] font-black uppercase transition-all ${filter === '3M' && !customDates.start ? 'bg-white text-slate-900 shadow-lg' : 'text-white/60 hover:text-white'}`}>3 Bulan</button>
                                        </div>
                                    </div>
                                </header>
                                
                                <DashboardUnit unit="zan" data={masterData.trends.zan} />
                                <div className="h-px bg-slate-200"></div>
                                <DashboardUnit unit="dnk" data={masterData.trends.dnk} />
                            </div>
                        )}
                    </div>
                    {toast.show && (<div className="fixed bottom-10 left-1/2 -translate-x-1/2 z-[1000] bg-slate-900 text-white px-8 py-4 rounded-3xl shadow-2xl animate-in slide-in-from-bottom-10 border border-white/10"><div className="flex items-center gap-3"><Icon name="check" className="w-5 h-5 text-green-400" /><span className="text-[11px] font-black uppercase tracking-widest tracking-tighter">{toast.message}</span></div></div>)}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
